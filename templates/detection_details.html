<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Detections for Rule</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { 
            margin: 20px; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
        }
        .log-display {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Courier New', monospace;
            max-height: 250px;
            overflow-y: auto;
            border-radius: 8px;
        }
        .chat-box {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 15px;
            min-height: 350px;
            overflow-y: auto;
            margin-bottom: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-bubble {
            padding: 12px 16px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .user-message {
            align-self: flex-end;
            background-color: #007bff;
            color: #ffffff;
            border-bottom-right-radius: 4px;
        }
        .ai-response {
            align-self: flex-start;
            background-color: #e9ecef;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .ai-loading {
            align-self: flex-start;
            color: #6c757d;
            font-style: italic;
            padding: 12px 16px;
            border-radius: 20px;
            background-color: #f1f1f1;
            box-shadow: none;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .markdown-content p {
            margin: 0.5em 0;
        }
        .markdown-content strong {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Detections for Rule: {{ version_id }}</h1>
        <a href="/" class="btn btn-secondary mb-4">‚Üê Back to Rules</a>

        <form id="detectionsForm" method="GET" action="/detections/{{ version_id }}" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="start_time" class="form-label">Start Time (UTC)</label>
                    <input type="datetime-local" class="form-control" id="start_time" name="start_time" value="{{ start_time }}">
                </div>
                <div class="col-md-4">
                    <label for="end_time" class="form-label">End Time (UTC)</label>
                    <input type="datetime-local" class="form-control" id="end_time" name="end_time" value="{{ end_time }}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary">Filter</button>
                </div>
            </div>
        </form>

        <div class="row">
            <div class="col-md-8">
                <h3>Detections</h3>
                {% if detections %}
                <div class="accordion" id="detectionsAccordion">
                    {% for detection in detections %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                                Detection ID: {{ detection.get('id', 'N/A') }}
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#detectionsAccordion">
                            <div class="accordion-body">
                                <p><strong>Detection Time:</strong> {{ detection.get('detectionTime', 'N/A') }}</p>
                                <p><strong>Rule Name:</strong> {{ detection.get('detection', [{}])[0].get('ruleName', 'N/A') }}</p>
                                <hr>
                                <h5>Raw Logs</h5>
                                <div class="log-display">
                                    {{ detection.get('collectionElements', 'No logs found') | tojson(indent=2) }}
                                </div>
                                <hr>
                                <h5>Gemini AI Analysis</h5>
                                <div class="chat-box" id="chat-box-{{ loop.index }}"></div>
                                <div class="input-group mt-3">
                                    <input type="text" class="form-control" placeholder="Ask Gemini about these logs..." id="chat-input-{{ loop.index }}">
                                    <button class="btn btn-primary" type="button" onclick="sendMessage({{ loop.index }})">Send</button>
                                </div>
                                
                                <hr>
                                <h5>Historical UDM Search</h5>
                                <div class="card p-3">
                                    <div class="mb-3">
                                        <label for="udm_query_input_{{ loop.index }}" class="form-label">UDM Query</label>
                                        <textarea class="form-control" id="udm_query_input_{{ loop.index }}" rows="2" placeholder="e.g., target.user.hostname = 'some-host' or ip = '1.2.3.4'"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="udm_start_time_{{ loop.index }}" class="form-label">Start Time</label>
                                            <input type="datetime-local" class="form-control" id="udm_start_time_{{ loop.index }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="udm_end_time_{{ loop.index }}" class="form-label">End Time</label>
                                            <input type="datetime-local" class="form-control" id="udm_end_time_{{ loop.index }}">
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-info" type="button" onclick="searchUdmLogs({{ loop.index }})">Search UDM Logs & Analyze</button>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p>No detections found for the selected time frame.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.10/lib/marked.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function convertToIsoFormat(dtStr) {
            if (!dtStr) return null;
            try {
                const localDate = new Date(dtStr);

                if (isNaN(localDate.getTime())) {
                    console.error("Invalid date string:", dtStr);
                    return null;
                }

                return localDate.toISOString().replace(/\.\d{3}Z$/, 'Z');
            } catch (e) {
                console.error("Date conversion failed:", e);
                return null;
            }
        }

        // Handles the form submission for detections
        document.getElementById('detectionsForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const form = event.target;
            const start_time_local = document.getElementById('start_time').value;
            const end_time_local = document.getElementById('end_time').value;

            const start_time_iso = convertToIsoFormat(start_time_local);
            const end_time_iso = convertToIsoFormat(end_time_local);
            
            if (!start_time_iso || !end_time_iso) {
                alert("Invalid date or time range. Please check your input.");
                return;
            }
            
            const url = new URL(form.action);
            url.searchParams.set('start_time', start_time_local);
            url.searchParams.set('end_time', end_time_local);
            
            window.location.href = url.href;
        });

        function sendMessage(detectionIndex) {
            const inputElement = document.getElementById(`chat-input-${detectionIndex}`);
            const chatBoxElement = document.getElementById(`chat-box-${detectionIndex}`);
            const userMessage = inputElement.value;
            
            if (!userMessage) return;

            const logsData = {{ detections | tojson }}[detectionIndex - 1].collectionElements;
            const logsString = JSON.stringify(logsData, null, 2);

            sendToChatApi(userMessage, logsString, chatBoxElement, inputElement);
        }

        function searchUdmLogs(detectionIndex) {
            const udmQuery = document.getElementById(`udm_query_input_${detectionIndex}`).value;
            const udmStartTime = document.getElementById(`udm_start_time_${detectionIndex}`).value;
            const udmEndTime = document.getElementById(`udm_end_time_${detectionIndex}`).value;
            const chatBoxElement = document.getElementById(`chat-box-${detectionIndex}`);
            
            if (!udmQuery || !udmStartTime || !udmEndTime) {
                alert("Please fill in all UDM search fields.");
                return;
            }
            
            const udmStartTimeIso = convertToIsoFormat(udmStartTime);
            const udmEndTimeIso = convertToIsoFormat(udmEndTime);

            if (!udmStartTimeIso || !udmEndTimeIso) {
                alert("Invalid date format. Please check the start and end times.");
                return;
            }

            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble ai-loading';
            loadingBubble.textContent = 'Searching UDM logs...';
            chatBoxElement.appendChild(loadingBubble);
            chatBoxElement.scrollTop = chatBoxElement.scrollHeight;

            let dotCount = 0;
            const loadingInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                loadingBubble.textContent = 'Searching UDM logs' + '.'.repeat(dotCount);
            }, 500);

            fetch("/api/udm_search", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    query: udmQuery,
                    start_time: udmStartTimeIso,
                    end_time: udmEndTimeIso,
                    limit: 100
                }),
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(loadingInterval);
                chatBoxElement.removeChild(loadingBubble);

                if (data.error) {
                    const errorBubble = document.createElement('div');
                    errorBubble.className = 'chat-bubble ai-response';
                    errorBubble.innerHTML = `<span style="color: red;">UDM Search failed: ${data.error}</span>`;
                    chatBoxElement.appendChild(errorBubble);
                } else {
                    const udmLogsString = JSON.stringify(data.logs, null, 2);
                    const prompt = "Please analyze the following UDM logs and provide a summary of the activity found.";
                    
                    sendToChatApi(prompt, udmLogsString, chatBoxElement, null);
                }
            })
            .catch(error => {
                clearInterval(loadingInterval);
                chatBoxElement.removeChild(loadingBubble);
                
                const errorBubble = document.createElement('div');
                errorBubble.className = 'chat-bubble ai-response';
                errorBubble.innerHTML = `<span style="color: red;">Network Error during UDM search: ${error}</span>`;
                chatBoxElement.appendChild(errorBubble);
            });
        }

        function sendToChatApi(userPrompt, logsString, chatBoxElement, inputElement) {
            let loadingInterval;
            
            if (inputElement) {
                const userBubble = document.createElement('div');
                userBubble.className = 'chat-bubble user-message';
                userBubble.textContent = `You: ${userPrompt}`;
                chatBoxElement.appendChild(userBubble);
                inputElement.value = "";
            }

            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble ai-loading';
            loadingBubble.textContent = 'Analyzing logs...';
            chatBoxElement.appendChild(loadingBubble);
            chatBoxElement.scrollTop = chatBoxElement.scrollHeight;

            let dotCount = 0;
            loadingInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                loadingBubble.textContent = 'Analyzing logs' + '.'.repeat(dotCount);
            }, 500);

            fetch("/api/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    logs: logsString,
                    prompt: userPrompt
                }),
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(loadingInterval);
                chatBoxElement.removeChild(loadingBubble);

                const aiBubble = document.createElement('div');
                aiBubble.className = 'chat-bubble ai-response';
                
                if (data.response) {
                    const htmlContent = marked.parse(data.response);
                    aiBubble.innerHTML = htmlContent;
                } else {
                    aiBubble.innerHTML = `<span style="color: red;">Error: ${data.error}</span>`;
                }
                
                chatBoxElement.appendChild(aiBubble);
                chatBoxElement.scrollTop = chatBoxElement.scrollHeight;
            })
            .catch(error => {
                clearInterval(loadingInterval);
                chatBoxElement.removeChild(loadingBubble);
                
                const errorBubble = document.createElement('div');
                errorBubble.className = 'chat-bubble ai-response';
                errorBubble.innerHTML = `<span style="color: red;">Network Error: ${error}</span>`;
                chatBoxBoxElement.appendChild(errorBubble);
                chatBoxElement.scrollTop = chatBoxElement.scrollHeight;
            });
        }
    </script>
</body>
</html>
